# Nginx Configuration Fix for 502 Bad Gateway Timeouts
# Add these settings to your nginx configuration file

# In the http block or server block:
server {
    # ... your existing configuration ...

    # === TIMEOUT SETTINGS ===
    # Increase proxy timeouts for long-running requests
    proxy_connect_timeout       300s;    # Time to connect to backend
    proxy_send_timeout          300s;    # Time to send request to backend  
    proxy_read_timeout          300s;    # Time to read response from backend
    proxy_buffering             off;     # Disable buffering for streaming responses
    
    # Client timeouts
    client_body_timeout         60s;     # Time to read client request body
    client_header_timeout       60s;     # Time to read client request headers
    send_timeout                300s;    # Time to send response to client
    
    # === BUFFER SETTINGS ===
    # Increase buffer sizes for large responses
    proxy_buffer_size           128k;    # Buffer size for response headers
    proxy_buffers               4 256k;  # Number and size of buffers for response
    proxy_busy_buffers_size     256k;    # Size of busy buffers
    client_max_body_size        50M;     # Max request body size
    
    # === KEEPALIVE SETTINGS ===
    # Improve connection handling
    keepalive_timeout           65s;     # Keep connections alive
    keepalive_requests          1000;    # Max requests per connection
    
    # === SPECIFIC LOCATION FOR EXPORTS ===
    # Special handling for export endpoints
    location ~ ^/export_cases {
        proxy_pass http://your_backend;
        
        # Extended timeouts for exports specifically
        proxy_connect_timeout       600s;    # 10 minutes
        proxy_send_timeout          600s;    # 10 minutes  
        proxy_read_timeout          600s;    # 10 minutes
        send_timeout                600s;    # 10 minutes
        
        # Disable buffering for streaming responses
        proxy_buffering             off;
        proxy_cache                 off;
        
        # Headers to prevent caching
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        
        # Enable streaming
        proxy_set_header Connection "";
        proxy_http_version 1.1;
    }
    
    # ... rest of your configuration ...
}

# === ALTERNATIVE: Global HTTP Block Settings ===
# If you want to apply these globally, add to the http block:

http {
    # Global timeout settings
    proxy_connect_timeout       300s;
    proxy_send_timeout          300s;
    proxy_read_timeout          300s;
    send_timeout                300s;
    
    # Global buffer settings  
    proxy_buffer_size           128k;
    proxy_buffers               4 256k;
    proxy_busy_buffers_size     256k;
    client_max_body_size        50M;
    
    # ... your server blocks ...
}
